<?php
/**
 * @file
 * Crownpeak DQM module file.
 */

/**
 * Implements hook_toolbar().
 */
function crownpeak_dqm_toolbar() {
  $items = [];

  if (\Drupal::currentUser()->hasPermission('administer crownpeak dqm') && _crownpeak_dqm_should_show_toolbar()) {
    $items['crownpeak_dqm'] = [
      '#type' => 'toolbar_item',
      'tab' => [
        '#type' => 'link',
        '#title' => t('Crownpeak DQM'),
        '#url' => \Drupal\Core\Url::fromRoute('<current>'),
        '#attributes' => [
          'class' => ['trigger', 'toolbar-item'],
          'id' => 'toolbar-item-crownpeak-dqm',
          'data-toolbar-tray' => 'toolbar-item-crownpeak-dqm-tray',
          'role' => 'button',
          'aria-pressed' => 'false',
        ],
      ],
      'tray' => [
        '#type' => 'container',
        '#attributes' => [
          'id' => 'toolbar-item-crownpeak-dqm-tray',
          'class' => ['toolbar-tray', 'toolbar-tray-vertical'],
          'data-toolbar-tray' => 'toolbar-item-crownpeak-dqm-tray',
        ],
        'content' => [
          '#type' => 'container',
          '#attributes' => ['class' => ['crownpeak-dqm-toolbar-tray']],
          'run_quality_check' => [
            '#type' => 'button',
            '#value' => t('Run Quality Check'),
            '#attributes' => [
              'class' => ['crownpeak-dqm-run-quality-check'],
            ],
          ],
        ],
      ],
      '#weight' => 100,
    ];
  }
  return $items;
}

/**
 * Implements hook_page_attachments().
 */
function crownpeak_dqm_page_attachments(array &$attachments) {
  if (\Drupal::currentUser()->hasPermission('administer crownpeak dqm') && _crownpeak_dqm_should_show_toolbar()) {
    $attachments['#attached']['library'][] = 'crownpeak_dqm/toolbar';
  }
}

/**
 * Helper function to determine if the toolbar should be shown.
 * 
 * @return bool
 *   TRUE if the toolbar should be shown, FALSE otherwise.
 */
function _crownpeak_dqm_should_show_toolbar() {
  $route_match = \Drupal::routeMatch();
  $current_route = $route_match->getRouteName();
  $current_path = \Drupal::service('path.current')->getPath();
  
  if (strpos($current_path, '/admin') === 0) {
    return FALSE;
  }
  
  if (strpos($current_path, '/user') === 0) {
    return FALSE;
  }
  
  $system_routes = [
    'system.batch_page.html',
    'system.batch_page.json',
    'system.cron',
    'system.db_update',
    'update.status',
    'update.module_update',
    'update.theme_update',
  ];
  
  if (in_array($current_route, $system_routes)) {
    return FALSE;
  }
  
  if ($current_route && (
    strpos($current_route, 'entity.node.') === 0 ||
    strpos($current_route, 'node.') === 0 ||
    $current_route === 'node.add' ||
    $current_route === 'node.add_page'
  )) {
    return TRUE;
  }
  
  if ($current_route && strpos($current_route, 'entity.taxonomy_term.') === 0) {
    return TRUE;
  }
  
  if ($current_route === 'view.frontpage.page_1' || 
      $current_route === '<front>' || 
      $current_route === 'system.404' ||
      $current_route === 'system.403') {
    return TRUE;
  }
  
  $node = $route_match->getParameter('node');
  if ($node && $node instanceof \Drupal\node\NodeInterface) {
    return TRUE;
  }
  
  if (!preg_match('/^(admin|user|batch|cron|update|install|core)/', $current_path) && 
      !preg_match('/\.(css|js|ico|png|jpg|jpeg|gif|svg)$/', $current_path)) {
    return TRUE;
  }
  
  return FALSE;
}